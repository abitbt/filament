<?php

/**
 * Filament 4 Widget Examples
 * Based on official Filament demo app patterns
 */

// =============================================================================
// Stats Widget with Page Table Integration
// =============================================================================

namespace App\Filament\Resources\Shop\Products\Widgets;

use App\Filament\Resources\Shop\Products\ProductResource\Pages\ListProducts;
use Filament\Widgets\Concerns\InteractsWithPageTable;
use Filament\Widgets\StatsOverviewWidget;
use Filament\Widgets\StatsOverviewWidget\Stat;

/**
 * Stats widget that responds to table filters
 * Uses InteractsWithPageTable to access filtered query
 */
class ProductStats extends StatsOverviewWidget
{
    use InteractsWithPageTable;

    protected static ?string $pollingInterval = null;

    protected function getTablePage(): string
    {
        return ListProducts::class;
    }

    protected function getStats(): array                    // Not getCards()
    {
        $query = $this->getPageTableQuery();

        return [
            Stat::make('Total Products', $query->count())
                ->description('All products in catalog')
                ->descriptionIcon('heroicon-m-shopping-bag')
                ->color('primary'),

            Stat::make('Published', $query->where('is_visible', true)->count())
                ->description('Visible to customers')
                ->descriptionIcon('heroicon-m-check-circle')
                ->color('success'),

            Stat::make('Low Stock', $query->where('qty', '<', 10)->count())
                ->description('Less than 10 in stock')
                ->descriptionIcon('heroicon-m-exclamation-triangle')
                ->color('warning'),

            Stat::make('Out of Stock', $query->where('qty', 0)->count())
                ->description('Needs restocking')
                ->descriptionIcon('heroicon-m-x-circle')
                ->color('danger'),
        ];
    }
}

// =============================================================================
// Dashboard Stats with Page Filters
// =============================================================================

namespace App\Filament\Widgets;

use App\Models\Shop\Order;
use Carbon\Carbon;
use Filament\Widgets\Concerns\InteractsWithPageFilters;
use Filament\Widgets\StatsOverviewWidget;
use Filament\Widgets\StatsOverviewWidget\Stat;
use Illuminate\Support\Number;

/**
 * Dashboard stats that respond to dashboard-level filters
 * Uses InteractsWithPageFilters to access filter values
 */
class StatsOverview extends StatsOverviewWidget
{
    use InteractsWithPageFilters;

    protected static ?string $pollingInterval = '15s';      // Non-static in v4

    protected static ?int $sort = 0;

    protected function getStats(): array
    {
        $startDate = $this->filters['startDate'] ?? null;
        $endDate = $this->filters['endDate'] ?? null;

        $query = Order::query()
            ->when($startDate, fn ($q) => $q->whereDate('created_at', '>=', $startDate))
            ->when($endDate, fn ($q) => $q->whereDate('created_at', '<=', $endDate));

        $revenue = $query->sum('total_price');
        $orderCount = $query->count();
        $newCustomers = $query->distinct('customer_id')->count('customer_id');

        return [
            Stat::make('Revenue', Number::currency($revenue, 'USD'))
                ->description('Total order revenue')
                ->descriptionIcon('heroicon-m-arrow-trending-up')
                ->chart([7, 3, 4, 5, 6, 3, 5, 8])
                ->color('success'),

            Stat::make('Orders', Number::format($orderCount))
                ->description('Total orders placed')
                ->descriptionIcon('heroicon-m-shopping-cart')
                ->chart([3, 5, 2, 8, 4, 6, 7, 5])
                ->color('primary'),

            Stat::make('New Customers', Number::format($newCustomers))
                ->description('Unique customers')
                ->descriptionIcon('heroicon-m-user-plus')
                ->chart([5, 4, 6, 3, 7, 5, 4, 6])
                ->color('info'),
        ];
    }
}

// =============================================================================
// Chart Widget with Filters
// =============================================================================

namespace App\Filament\Widgets;

use App\Models\Shop\Order;
use Carbon\Carbon;
use Filament\Widgets\ChartWidget;
use Filament\Widgets\Concerns\InteractsWithPageFilters;

class OrdersChart extends ChartWidget
{
    use InteractsWithPageFilters;

    protected ?string $heading = 'Orders per Month';        // Non-static in v4
    protected ?string $description = 'Monthly order trends';
    protected ?string $pollingInterval = null;              // Non-static in v4

    protected static ?string $maxHeight = '300px';
    protected static ?int $sort = 1;

    protected function getType(): string
    {
        return 'line';  // line, bar, pie, doughnut, radar, polarArea
    }

    protected function getData(): array
    {
        $startDate = $this->filters['startDate'] ?? now()->subMonths(6);
        $endDate = $this->filters['endDate'] ?? now();

        $data = Order::query()
            ->selectRaw('MONTH(created_at) as month, COUNT(*) as count')
            ->whereDate('created_at', '>=', $startDate)
            ->whereDate('created_at', '<=', $endDate)
            ->groupByRaw('MONTH(created_at)')
            ->orderByRaw('MONTH(created_at)')
            ->pluck('count', 'month')
            ->toArray();

        $labels = [];
        $values = [];

        for ($i = 1; $i <= 12; $i++) {
            $labels[] = Carbon::create()->month($i)->format('M');
            $values[] = $data[$i] ?? 0;
        }

        return [
            'datasets' => [
                [
                    'label' => 'Orders',
                    'data' => $values,
                    'fill' => true,
                    'backgroundColor' => 'rgba(59, 130, 246, 0.1)',
                    'borderColor' => 'rgb(59, 130, 246)',
                    'tension' => 0.3,
                ],
            ],
            'labels' => $labels,
        ];
    }

    protected function getOptions(): array
    {
        return [
            'scales' => [
                'y' => [
                    'beginAtZero' => true,
                    'ticks' => [
                        'stepSize' => 1,
                    ],
                ],
            ],
            'plugins' => [
                'legend' => [
                    'display' => false,
                ],
            ],
        ];
    }
}

// =============================================================================
// Chart Widget with Schema-Based Filters
// =============================================================================

namespace App\Filament\Widgets;

use Filament\Forms\Components\DatePicker;
use Filament\Forms\Components\Select;
use Filament\Schemas\Schema;
use Filament\Widgets\ChartWidget;
use Filament\Widgets\ChartWidget\Concerns\HasFiltersSchema;

class RevenueChart extends ChartWidget
{
    use HasFiltersSchema;

    protected ?string $heading = 'Revenue Breakdown';
    protected static ?int $sort = 2;

    /**
     * Custom filter form with Schema-based components
     */
    public function filtersSchema(Schema $schema): Schema
    {
        return $schema->components([
            DatePicker::make('startDate')
                ->label('From')
                ->default(now()->subDays(30)),

            DatePicker::make('endDate')
                ->label('To')
                ->default(now()),

            Select::make('groupBy')
                ->label('Group By')
                ->options([
                    'day' => 'Daily',
                    'week' => 'Weekly',
                    'month' => 'Monthly',
                ])
                ->default('day'),
        ]);
    }

    protected function getType(): string
    {
        return 'bar';
    }

    protected function getData(): array
    {
        $startDate = $this->filters['startDate'] ?? now()->subDays(30);
        $endDate = $this->filters['endDate'] ?? now();
        $groupBy = $this->filters['groupBy'] ?? 'day';

        // Build query based on groupBy selection
        // ... implementation depends on database

        return [
            'datasets' => [
                [
                    'label' => 'Revenue',
                    'data' => [1200, 1900, 3000, 5000, 2300, 3200, 4500],
                    'backgroundColor' => 'rgba(16, 185, 129, 0.8)',
                ],
            ],
            'labels' => ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        ];
    }
}

// =============================================================================
// Table Widget (Latest Orders)
// =============================================================================

namespace App\Filament\Widgets;

use App\Models\Shop\Order;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Table;
use Filament\Widgets\TableWidget;

class LatestOrders extends TableWidget
{
    protected int|string|array $columnSpan = 'full';

    protected static ?int $sort = 3;

    public function table(Table $table): Table
    {
        return $table
            ->query(Order::query()->latest()->limit(5))
            ->columns([
                TextColumn::make('number')
                    ->label('Order #')
                    ->searchable(),

                TextColumn::make('customer.name')
                    ->label('Customer')
                    ->searchable(),

                TextColumn::make('total_price')
                    ->money('USD')
                    ->sortable(),

                TextColumn::make('status')
                    ->badge()
                    ->color(fn (string $state) => match ($state) {
                        'pending' => 'warning',
                        'processing' => 'primary',
                        'shipped' => 'info',
                        'delivered' => 'success',
                        'cancelled' => 'danger',
                        default => 'gray',
                    }),

                TextColumn::make('created_at')
                    ->label('Date')
                    ->dateTime()
                    ->sortable(),
            ])
            ->paginated(false);
    }
}

// =============================================================================
// Dashboard Page with Filters Form
// =============================================================================

namespace App\Filament\Pages;

use Filament\Forms\Components\DatePicker;
use Filament\Forms\Components\Section;
use Filament\Pages\Dashboard as BaseDashboard;
use Filament\Schemas\Schema;

class Dashboard extends BaseDashboard
{
    use BaseDashboard\Concerns\HasFiltersForm;

    /**
     * Dashboard-level filters that widgets can access
     * via InteractsWithPageFilters trait
     */
    public function filtersForm(Schema $schema): Schema
    {
        return $schema->components([
            Section::make()
                ->schema([
                    DatePicker::make('startDate')
                        ->label('From')
                        ->default(now()->subDays(30)),

                    DatePicker::make('endDate')
                        ->label('To')
                        ->default(now()),
                ])
                ->columns(2),
        ]);
    }
}
